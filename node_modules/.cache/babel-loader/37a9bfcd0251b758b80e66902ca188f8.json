{"ast":null,"code":"import { useCallback, useEffect, useState } from \"react\";\nimport useLocal from \"./local.hook\";\nimport { TypeMessage } from \"./TypeMessage\";\n\nconst useWS = (notes, setNotes) => {\n  const [connection, setConnection] = useState(null);\n  const {\n    saveInLocal,\n    getFromLocal,\n    removeInLocal\n  } = useLocal();\n  const [currentNotes, setCurrentNotes] = useState(notes);\n\n  function setArrayNotes(serverNote) {\n    console.log('set array notes');\n    serverNote.forEach(note => {\n      saveInLocal(note.id, JSON.stringify(note));\n    });\n    setNotes(() => serverNote);\n  }\n\n  const compare = (localNote, serverNote) => localNote.x === serverNote.x && localNote.y === serverNote.y && localNote.width === serverNote.width && localNote.height === serverNote.height;\n\n  const update = (serverNote, data) => {\n    console.log('Update: old notes', notes, \"add\", serverNote);\n    saveInLocal(serverNote.id, data);\n    const index = notes.findIndex(note => note.id === serverNote.id);\n    const fromLocal = getFromLocal(serverNote.id);\n    const parse = JSON.parse(fromLocal); // if (!compare(parse, serverNote)) {\n\n    console.log(notes.length, serverNote);\n\n    if (notes.length !== 0) {\n      console.log('update');\n      notes[index] = serverNote;\n      setNotes([...notes]);\n    } else {\n      console.log('create');\n      setNotes(prev => [...prev, serverNote]);\n    } // }\n\n  };\n\n  const updatePosition = ({\n    data\n  }) => {\n    if (data) {\n      const respNote = JSON.parse(data);\n\n      if (!respNote.type && Array.isArray(respNote)) {\n        console.log(\"initial\");\n        setArrayNotes(respNote);\n        return;\n      }\n\n      if (respNote.type === TypeMessage.UPDATE) {\n        console.log(TypeMessage.UPDATE);\n        update(respNote, data);\n      } else if (respNote.type === TypeMessage.CREATE) {\n        console.log(TypeMessage.CREATE);\n        update(respNote, data);\n      } else if (respNote.type === TypeMessage.DELETE) {\n        console.log('remove');\n        removeInLocal(respNote.id);\n        setNotes(notes.filter(note => note.id !== respNote.id));\n      } else {\n        console.error('Incorrect data message', data);\n      }\n    }\n  }; // const getPositions = ({data}) => {\n  //     console.log(\"get positions\", data)\n  //     if (data) {\n  //         const serverNotes = JSON.parse(data);\n  //         setNotes(serverNotes)\n  //         serverNotes.forEach(note => {\n  //             saveInLocal(note.id, note)\n  //         })\n  //     }\n  // }\n\n\n  const test = data => {\n    console.log(data);\n  };\n\n  useEffect(() => {\n    if (connection === null) {\n      const url = window.location.href.replace(/^http/, 'ws').replace(/3000\\/$/, '5000/');\n      console.log(url);\n      const webSocket = new WebSocket(url);\n      webSocket.onmessage = updatePosition;\n      webSocket.onopen = test;\n      setConnection(webSocket);\n    }\n  }, [connection]);\n  return {\n    connection\n  };\n};\n\nexport default useWS;","map":{"version":3,"sources":["/home/deathsmell/WebstormProjects/i-note-common/src/hooks/ws.hook.js"],"names":["useCallback","useEffect","useState","useLocal","TypeMessage","useWS","notes","setNotes","connection","setConnection","saveInLocal","getFromLocal","removeInLocal","currentNotes","setCurrentNotes","setArrayNotes","serverNote","console","log","forEach","note","id","JSON","stringify","compare","localNote","x","y","width","height","update","data","index","findIndex","fromLocal","parse","length","prev","updatePosition","respNote","type","Array","isArray","UPDATE","CREATE","DELETE","filter","error","test","url","window","location","href","replace","webSocket","WebSocket","onmessage","onopen"],"mappings":"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","sourcesContent":["import {useCallback, useEffect, useState} from \"react\";\nimport useLocal from \"./local.hook\";\nimport {TypeMessage} from \"./TypeMessage\";\n\n\nconst useWS = (notes,setNotes) => {\n\n    const [connection, setConnection] = useState(null);\n    const {saveInLocal, getFromLocal, removeInLocal} = useLocal();\n    const [currentNotes,setCurrentNotes] = useState(notes);\n\n    function setArrayNotes(serverNote) {\n        console.log('set array notes')\n        serverNote.forEach(note => {\n            saveInLocal(note.id, JSON.stringify(note))\n        })\n        setNotes(() => serverNote)\n    }\n\n    const compare = (localNote, serverNote) => localNote.x === serverNote.x\n        && localNote.y === serverNote.y\n        && localNote.width === serverNote.width\n        && localNote.height === serverNote.height\n\n\n    const update = (serverNote, data) => {\n        console.log('Update: old notes', notes, \"add\", serverNote)\n        saveInLocal(serverNote.id, data)\n        const index = notes.findIndex(note => note.id === serverNote.id);\n        const fromLocal = getFromLocal(serverNote.id);\n        const parse = JSON.parse(fromLocal);\n        // if (!compare(parse, serverNote)) {\n        console.log(notes.length, serverNote)\n        if (notes.length !== 0) {\n            console.log('update')\n            notes[index] = serverNote\n            setNotes([...notes])\n        } else {\n            console.log('create')\n            setNotes((prev) => [...prev,serverNote])\n        }\n        // }\n    }\n\n    const updatePosition = ({data}) => {\n        if (data) {\n            const respNote = JSON.parse(data);\n            if (!respNote.type && Array.isArray(respNote)) {\n                console.log(\"initial\")\n                setArrayNotes(respNote);\n                return;\n            }\n            if (respNote.type === TypeMessage.UPDATE) {\n                console.log(TypeMessage.UPDATE)\n                update(respNote, data);\n            } else if (respNote.type === TypeMessage.CREATE) {\n                console.log(TypeMessage.CREATE)\n                update(respNote, data);\n            } else if (respNote.type === TypeMessage.DELETE) {\n                console.log('remove')\n                removeInLocal(respNote.id)\n                setNotes(notes.filter(note => note.id !== respNote.id))\n            } else {\n                console.error('Incorrect data message', data)\n            }\n        }\n    }\n\n    // const getPositions = ({data}) => {\n    //     console.log(\"get positions\", data)\n    //     if (data) {\n    //         const serverNotes = JSON.parse(data);\n    //         setNotes(serverNotes)\n    //         serverNotes.forEach(note => {\n    //             saveInLocal(note.id, note)\n    //         })\n    //     }\n    // }\n\n    const test = (data) => {\n        console.log(data)\n    }\n\n    useEffect(() => {\n        if (connection === null) {\n            const url = window.location.href\n                .replace(/^http/, 'ws')\n                .replace(/3000\\/$/, '5000/');\n            console.log(url)\n            const webSocket = new WebSocket(url)\n            webSocket.onmessage = updatePosition\n            webSocket.onopen = test\n            setConnection(webSocket)\n        }\n    }, [connection])\n\n    return {connection}\n}\n\nexport default useWS"]},"metadata":{},"sourceType":"module"}