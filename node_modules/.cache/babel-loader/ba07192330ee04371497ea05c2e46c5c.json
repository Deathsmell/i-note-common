{"ast":null,"code":"import { useEffect, useState } from \"react\";\nimport useLocal from \"./local.hook\";\nimport { TypeMessage } from \"./TypeMessage\";\n\nconst useWS = ([notes, setNotes]) => {\n  const [connection, setConnection] = useState(null);\n  const {\n    saveInLocal,\n    getFromLocal,\n    removeInLocal\n  } = useLocal();\n\n  const compare = (localNote, serverNote) => localNote.x === serverNote.x && localNote.y === serverNote.y && localNote.width === serverNote.width && localNote.height === serverNote.height;\n\n  const updatePosition = ({\n    data\n  }) => {\n    if (data) {\n      const serverNote = JSON.parse(data);\n      console.log('serverNote', serverNote, serverNote.type);\n\n      if (!serverNote.type && serverNote) {\n        serverNote.forEach(note => {\n          saveInLocal(note.id, JSON.stringify(note));\n        });\n        console.log(serverNote);\n        setNotes(serverNote);\n        return;\n      }\n\n      saveInLocal(serverNote.id, data);\n      const index = notes.findIndex(note => note.id === serverNote.id);\n\n      if (serverNote.type === TypeMessage.UPDATE) {\n        const fromLocal = getFromLocal(serverNote.id);\n        const parse = JSON.parse(fromLocal);\n\n        if (!compare(parse, serverNote)) {\n          const splice = notes.splice(index, 1, serverNote);\n          setNotes(() => splice);\n        }\n      } else if (serverNote.type === TypeMessage.CREATE) {\n        setNotes([...notes, serverNote]);\n      } else if (serverNote.type === TypeMessage.DELETE) {\n        removeInLocal(serverNote.id);\n        setNotes(notes.splice(index, 1));\n      } else {\n        console.error('Incorrect data message', data);\n      }\n    }\n  };\n\n  const getPositions = ({\n    data\n  }) => {\n    console.log(\"get positions\", data);\n\n    if (data) {\n      const serverNotes = JSON.parse(data);\n      setNotes(serverNotes);\n      serverNotes.forEach(note => {\n        saveInLocal(note.id, note);\n      });\n    }\n  };\n\n  const test = ({\n    data\n  }) => {\n    console.log(data);\n  };\n\n  useEffect(() => {\n    if (connection === null) {\n      const webSocket = new WebSocket('ws://localhost:8080');\n      webSocket.onmessage = updatePosition; // webSocket.onopen = getPositions\n\n      webSocket.onopen = test; // webSocket.onmessage = test\n\n      setConnection(webSocket);\n    }\n  }, [connection]);\n  return {\n    connection\n  };\n};\n\nexport default useWS;","map":{"version":3,"sources":["/home/deathsmell/WebstormProjects/i-note-common/src/hooks/ws.hook.js"],"names":["useEffect","useState","useLocal","TypeMessage","useWS","notes","setNotes","connection","setConnection","saveInLocal","getFromLocal","removeInLocal","compare","localNote","serverNote","x","y","width","height","updatePosition","data","JSON","parse","console","log","type","forEach","note","id","stringify","index","findIndex","UPDATE","fromLocal","splice","CREATE","DELETE","error","getPositions","serverNotes","test","webSocket","WebSocket","onmessage","onopen"],"mappings":"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","sourcesContent":["import {useEffect, useState} from \"react\";\nimport useLocal from \"./local.hook\";\nimport {TypeMessage} from \"./TypeMessage\";\n\n\nconst useWS = ([notes, setNotes]) => {\n\n    const [connection, setConnection] = useState(null);\n    const {saveInLocal, getFromLocal, removeInLocal} = useLocal();\n\n    const compare = (localNote, serverNote) => localNote.x === serverNote.x\n        && localNote.y === serverNote.y\n        && localNote.width === serverNote.width\n        && localNote.height === serverNote.height\n\n\n    const updatePosition = ({data}) => {\n        if (data) {\n            const serverNote = JSON.parse(data);\n            console.log('serverNote', serverNote, serverNote.type)\n            if (!serverNote.type && serverNote) {\n                serverNote.forEach(note => {\n                    saveInLocal(note.id, JSON.stringify(note))\n                })\n                console.log(serverNote)\n                setNotes(serverNote)\n                return;\n            }\n            saveInLocal(serverNote.id, data)\n            const index = notes.findIndex(note => note.id === serverNote.id);\n            if (serverNote.type === TypeMessage.UPDATE) {\n                const fromLocal = getFromLocal(serverNote.id);\n                const parse = JSON.parse(fromLocal);\n\n                if (!compare(parse, serverNote)) {\n                    const splice = notes.splice(index, 1, serverNote);\n                    setNotes(() => splice)\n                }\n            } else if (serverNote.type === TypeMessage.CREATE) {\n                setNotes([...notes, serverNote])\n            } else if (serverNote.type === TypeMessage.DELETE) {\n                removeInLocal(serverNote.id)\n                setNotes(notes.splice(index, 1))\n            } else {\n                console.error('Incorrect data message', data)\n            }\n        }\n    }\n\n    const getPositions = ({data}) => {\n        console.log(\"get positions\", data)\n        if (data) {\n            const serverNotes = JSON.parse(data);\n            setNotes(serverNotes)\n            serverNotes.forEach(note => {\n                saveInLocal(note.id, note)\n            })\n        }\n    }\n\n    const test = ({data}) => {\n        console.log(data)\n    }\n\n    useEffect(() => {\n        if (connection === null) {\n            const webSocket = new WebSocket('ws://localhost:8080');\n            webSocket.onmessage = updatePosition\n            // webSocket.onopen = getPositions\n            webSocket.onopen = test\n            // webSocket.onmessage = test\n            setConnection(webSocket)\n        }\n    }, [connection])\n\n    return {connection}\n}\n\nexport default useWS"]},"metadata":{},"sourceType":"module"}